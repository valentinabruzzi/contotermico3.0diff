class c{constructor(t={}){this.baseURL=t.baseURL||"",this.defaultHeaders=t.headers||{},this.timeout=t.timeout||3e4,this.csrfToken=this.getCsrfToken()}getCsrfToken(){const t=document.querySelector('meta[name="csrf-token"]');if(t)return t.getAttribute("content");const e=document.cookie.split("; ").find(r=>r.startsWith("XSRF-TOKEN="));return e?decodeURIComponent(e.split("=")[1]):(console.warn("CSRF token non trovato. Assicurati che il meta tag sia presente nel layout."),null)}async handleResponse(t){if(t.ok)return t.status===204?null:await t.json();let e=`HTTP Error ${t.status}`,r=null;try{r=await t.json()}catch{e=await t.text()||e}switch(t.status){case 401:e="Non autenticato. Effettua il login.";break;case 403:e="Non hai i permessi per questa operazione.";break;case 419:e="Sessione scaduta. Ricarica la pagina.";break;case 422:e="Errori di validazione",r&&r.errors&&console.error("Validation errors:",r.errors);break;case 500:e="Errore del server. Riprova piÃ¹ tardi.";break;default:r&&r.message&&(e=r.message)}const s=new Error(e);throw s.status=t.status,s.data=r,s}async request(t,e={}){const r=t.startsWith("http")?t:`${this.baseURL}${t}`,s={Accept:"application/json","Content-Type":"application/json",...this.defaultHeaders,...e.headers},n=(e.method||"GET").toUpperCase();["POST","PUT","PATCH","DELETE"].includes(n)&&this.csrfToken&&(s["X-CSRF-TOKEN"]=this.csrfToken);const a=new AbortController,i=setTimeout(()=>a.abort(),this.timeout);try{const o=await fetch(r,{...e,headers:s,signal:a.signal});return clearTimeout(i),await this.handleResponse(o)}catch(o){throw clearTimeout(i),o.name==="AbortError"?new Error(`Request timeout dopo ${this.timeout}ms`):(console.error(`API Error [${n} ${r}]:`,o),o)}}async get(t,e={}){const r=new URLSearchParams(Object.entries(e).filter(([n,a])=>a!=null&&a!=="")).toString(),s=r?`${t}?${r}`:t;return this.request(s,{method:"GET"})}async post(t,e={},r={}){return this.request(t,{method:"POST",body:JSON.stringify(e),...r})}async put(t,e={},r={}){return this.request(t,{method:"PUT",body:JSON.stringify(e),...r})}async patch(t,e={},r={}){return this.request(t,{method:"PATCH",body:JSON.stringify(e),...r})}async delete(t,e={}){return this.request(t,{method:"DELETE",...e})}async upload(t,e,r={}){const s={...r.headers};return delete s["Content-Type"],this.request(t,{method:"POST",body:e,...r,headers:s})}}const h=new c;export{h as a};
