import{a as d}from"./api-DMeO4uTB.js";import{A as c}from"./autocomplete-BEBxn4Ja.js";document.addEventListener("DOMContentLoaded",function(){const a=document.getElementsByClassName("address-context");c.closeOnClickOutside();const e=document.getElementById("simulatore-pubblico")!==null;for(let t of a){const i=t.value;new h(i,e)}});class h{constructor(e,t=!1){this.entity=e,this.isPublicSimulator=t,this.apiBase=t?"/api/public":"/api",this.regionInput=document.getElementById(`${e}_regione`),this.provinceInput=document.getElementById(`${e}_provincia`),this.cityInput=document.getElementById(`${e}_comune`),this.fields={provinceCode:document.getElementById(`${e}_codice_provincia`),belfioreCode:document.getElementById(`${e}_codice_belfiore`),climaticZone:document.getElementById(`${e}_zona_climatica`),elevationAsl:document.getElementById(`${e}_altitudine`),degreeDays:document.getElementById(`${e}_gradi_giorno`),lat:document.getElementById(`${e}_lat`),lng:document.getElementById(`${e}_lng`),population:document.getElementById(`${e}_abitanti`),country:document.getElementById(`${e}_stato`),countryCode:document.getElementById(`${e}_codice_stato`)},this.selectedRegion=null,this.selectedProvinceCode=null,this.validCitySelected=!1;const i=this.cityInput?.closest('[data-geo-search="global"]')||this.regionInput?.closest('[data-geo-search="global"]');this.isGlobalSearch=i!==null,this.isGlobalSearch&&this.cityInput&&(this.cityInput.readOnly=!1),this.initAutocomplete(),this.initializePrefilledRegion()}async apiGet(e,t={}){const i=new URL(`${this.apiBase}${e}`,window.location.origin);if(Object.entries(t).forEach(([n,o])=>{o!=null&&i.searchParams.append(n,o)}),this.isPublicSimulator){const n=await fetch(i);if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);return await n.json()}else return await d.get(`${this.apiBase}${e}`,t)}initAutocomplete(){this.regionInput&&(this.regionAutocomplete=new c(this.regionInput,{listId:`${this.entity}-regione-suggestions`,displayKey:"regione",onSelect:e=>this.handleRegionSelect(e),onInput:()=>this.handleRegionInput(),onBlur:()=>this.resetFields("regione")}),this.regionInput.addEventListener("input",()=>this.searchRegions()),this.regionInput.addEventListener("change",()=>this.resetFields("regione"))),this.provinceInput&&(this.provinceAutocomplete=new c(this.provinceInput,{listId:`${this.entity}-provincia-suggestions`,displayKey:"provincia",onSelect:e=>this.handleProvinceSelect(e),onInput:()=>this.handleProvinceInput(),onBlur:()=>this.resetFields("provincia")}),this.provinceInput.addEventListener("input",()=>this.searchProvinces()),this.provinceInput.addEventListener("change",()=>this.resetFields("provincia"))),this.cityInput&&(this.cityAutocomplete=new c(this.cityInput,{listId:`${this.entity}-comune-suggestions`,displayKey:this.isGlobalSearch?"display_name":"comune",onSelect:e=>this.handleCitySelect(e),onInput:()=>{this.validCitySelected=!1},onBlur:()=>{this.validCitySelected||this.resetFields("comune")}}),this.cityInput.addEventListener("input",()=>this.searchCities()),this.cityInput.addEventListener("change",()=>{this.validCitySelected||this.resetFields("comune")}))}async initializePrefilledRegion(){if(this.regionInput.value.trim()!==""&&this.regionInput.form)try{const e=await this.apiGet("/regions",{q:this.regionInput.value});e.length>0&&(this.selectedRegion=e[0].regione,this.provinceInput.readOnly=!1)}catch(e){console.error("Errore caricamento regione precompilata:",e)}}async searchRegions(){if(!(this.regionInput.value.length<2)){this.regionAutocomplete.showLoader();try{const e=await this.apiGet("/regions",{q:this.regionInput.value});this.regionAutocomplete.hideLoader(),this.regionAutocomplete.showSuggestions(e)}catch(e){console.error("Errore ricerca regioni:",e),this.regionAutocomplete.hideLoader()}}}async searchProvinces(){if(!(this.provinceInput.value.length<2||!this.selectedRegion)){this.provinceAutocomplete.showLoader();try{const e=await this.apiGet("/provinces",{q:this.provinceInput.value,regione:this.selectedRegion});this.provinceAutocomplete.hideLoader(),this.provinceAutocomplete.showSuggestions(e)}catch(e){console.error("Errore ricerca province:",e),this.provinceAutocomplete.hideLoader()}}}async searchCities(){if(!(this.cityInput.value.length<2)&&!(!this.isGlobalSearch&&!this.selectedProvinceCode)){this.cityAutocomplete.showLoader();try{const e={q:this.cityInput.value};this.isGlobalSearch||(e.codice_provincia=this.selectedProvinceCode);const t=await this.apiGet("/cities",e);this.isGlobalSearch&&t.forEach(i=>{i.display_name=`${i.comune} (${i.provincia})`}),this.cityAutocomplete.hideLoader(),this.cityAutocomplete.showSuggestions(t)}catch(e){console.error("Errore ricerca comuni:",e),this.cityAutocomplete.hideLoader()}}}handleRegionSelect(e){this.fields.country.value=e.stato,this.fields.countryCode.value=e.codice_stato,this.selectedRegion=e.regione,setTimeout(()=>{this.provinceInput.readOnly=!1,this.provinceInput.focus()},150)}handleProvinceSelect(e){this.fields.provinceCode.value=e.codice_provincia,this.selectedProvinceCode=e.codice_provincia,setTimeout(()=>{this.cityInput.readOnly=!1,this.cityInput.focus()},150)}handleCitySelect(e){this.fields.belfioreCode.value=e.codice_belfiore,this.fields.climaticZone.value=e.zona_climatica,this.fields.elevationAsl.value=e.altitudine,this.fields.degreeDays.value=e.gradi_giorno,this.fields.lat.value=e.lat,this.fields.lng.value=e.lng,this.fields.population.value=e.abitanti,this.fields.climaticZone.dispatchEvent(new Event("climaticZoneChange")),this.isGlobalSearch&&(this.regionInput.value=e.regione,this.provinceInput.value=e.provincia,this.fields.provinceCode.value=e.codice_provincia,this.fields.country.value=e.stato,this.fields.countryCode.value=e.codice_stato,this.selectedRegion=e.regione,this.selectedProvinceCode=e.codice_provincia,this.cityInput.value=e.comune),this.validCitySelected=!0,(!e.zona_climatica||e.zona_climatica===null)&&this.checkDualClimaticZone(e.comune)}handleRegionInput(){this.resetFields("regione")}handleProvinceInput(){this.resetFields("provincia")}async checkDualClimaticZone(e){try{const t=await this.apiGet("/dual-climatic-zones",{comune:e});t.hasDualZone&&t.zones&&this.openDualZoneModal(e,t.zones)}catch(t){console.error("Errore verifica doppia zona climatica:",t)}}openDualZoneModal(e,t){const i=`select-climatic-zone-${this.entity}`,n=document.getElementById(`dual-zone-city-${this.entity}`),o=document.getElementById(`dual-zone-select-${this.entity}`),r=document.getElementById(`confirm-dual-zone-${this.entity}`);if(!o||!r){console.error("Elementi modale non trovati");return}n&&(n.textContent=e),o.innerHTML='<option value="">Seleziona una zona</option>',t.forEach(s=>{const l=document.createElement("option");l.value=s,l.textContent=`Zona ${s}`,o.appendChild(l)}),r.onclick=()=>{const s=o.value;s&&(this.fields.climaticZone.value=s,this.fields.climaticZone.dispatchEvent(new Event("change",{bubbles:!0})),this.fields.climaticZone.dispatchEvent(new Event("climaticZoneChange")),window.dispatchEvent(new CustomEvent("close-modal",{detail:i})))},window.dispatchEvent(new CustomEvent("open-modal",{detail:i}))}resetFields(e){this.fields.belfioreCode.value="",this.fields.climaticZone.value="",this.fields.degreeDays.value="",this.fields.lat.value="",this.fields.lng.value="",this.fields.population.value="",this.fields.elevationAsl.value="",this.fields.climaticZone.dispatchEvent(new Event("climaticZoneChange")),this.validCitySelected=!1,e==="regione"?(this.selectedRegion=null,this.selectedProvinceCode=null,this.fields.provinceCode.value="",this.provinceInput.value="",this.provinceInput.readOnly=!0,this.cityInput.value="",this.cityInput.readOnly=!0):e==="provincia"&&(this.selectedProvinceCode=null,this.cityInput.value="",this.cityInput.readOnly=!0)}}
