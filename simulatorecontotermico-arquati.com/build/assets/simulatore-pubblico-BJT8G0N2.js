import{a as p,t as I}from"./forms-BesdW-TN.js";import{a as z}from"./api-DMeO4uTB.js";import{t as T,c,f as d}from"./dom-BI66pLWo.js";const S={hidden:"hidden"},C={pompa_calore:"Pompa di Calore",sistema_ibrido:"Sistema Ibrido Factory Made",solare_termico:"Solare Termico",scaldacqua:"Scaldacqua a Pompa di Calore",condizionatori:"Condizionatore",pannelli_acs:"Pannelli Solari ACS",pannelli_riscaldamento:"Pannelli Solari Riscaldamento"};class B{constructor(){this.form=document.getElementById("simulatore-pubblico"),this.form&&(this.brand=this.form.dataset.brand||"arquati",this.catalogCache=new Map,this.tipologiaAttivaInput=document.getElementById("tipologia-attiva"),this.currentTab=null,this.choicesInstances=new Map,this.resultsElements={placeholder:document.getElementById("results-placeholder"),loading:document.getElementById("results-loading"),error:document.getElementById("results-error"),errorMessage:document.getElementById("results-error-message"),table:document.getElementById("results-table"),body:document.getElementById("results-body"),warnings:document.getElementById("results-warnings"),warningsList:document.getElementById("warnings-list"),totalImporto:document.getElementById("total-importo"),totalLordo:document.getElementById("total-lordo"),totalNetto:document.getElementById("total-netto")},this.init())}init(){this.initTabNavigation(),this.bindModelSelectEvents(),this.bindCalculateButton(),this.bindFormSubmit()}initTabNavigation(){this.tabs={"sistema-ibrido":{button:document.getElementById("sistema-ibrido-tab"),pane:document.getElementById("sistema-ibrido")},"pompa-calore":{button:document.getElementById("pompa-calore-tab"),pane:document.getElementById("pompa-calore")},scaldacqua:{button:document.getElementById("scaldacqua-tab"),pane:document.getElementById("scaldacqua")},condizionatori:{button:document.getElementById("condizionatori-tab"),pane:document.getElementById("condizionatori")},"solare-termico":{button:document.getElementById("solare-termico-tab"),pane:document.getElementById("solare-termico")},"pannelli-acs":{button:document.getElementById("pannelli-acs-tab"),pane:document.getElementById("pannelli-acs")},"pannelli-riscaldamento":{button:document.getElementById("pannelli-riscaldamento-tab"),pane:document.getElementById("pannelli-riscaldamento")}},this.allTabButtons=Object.values(this.tabs).map(a=>a.button).filter(Boolean),this.allTabPanes=Object.values(this.tabs).map(a=>a.pane).filter(Boolean),this.allTabButtons.forEach(a=>{a.addEventListener("click",o=>{o.preventDefault();const i=o.currentTarget.getAttribute("aria-controls");this.switchTab(i)})});const t=this.allTabButtons.find(a=>a.getAttribute("aria-selected")==="true")?.getAttribute("aria-controls")||this.allTabButtons[0]?.getAttribute("aria-controls");t&&this.switchTab(t)}switchTab(e){this.allTabButtons.forEach(a=>{const o=a.getAttribute("aria-controls")===e;a.setAttribute("aria-selected",o),o?(a.classList.add("text-cornflower-blue-700","border-cornflower-blue-500"),a.classList.remove("border-transparent")):(a.classList.remove("text-cornflower-blue-700","border-cornflower-blue-500"),a.classList.add("border-transparent"))}),this.allTabPanes.forEach(a=>{T(a,a.id===e)});const t=this.allTabButtons.find(a=>a.getAttribute("aria-controls")===e);if(t){const a=t.dataset.tipologia,o=t.dataset.catalog,i=t.dataset.subtype||null;this.currentTab={tipologia:a,catalogType:o,subtype:i,tabId:e},this.tipologiaAttivaInput&&(this.tipologiaAttivaInput.value=a),this.loadCatalogForTab(o,i),this.updateComuneFieldVisibility(e)}}updateComuneFieldVisibility(e){const t=document.getElementById("comune-field-wrapper");if(!t)return;(t.dataset.hideFor?.split(",")||[]).includes(e)?c(t):d(t)}destroyAllChoices(){this.choicesInstances.forEach(e=>e.destroy()),this.choicesInstances.clear()}async loadCatalogForTab(e,t=null){const a=`${e}-${this.brand}${t?`-${t}`:""}`,o=this.currentTab?.tabId;if(!o)return;const i=document.getElementById(o);if(!i)return;const n=i.querySelectorAll(".btn-select-model");if(n.length){n.forEach(s=>{const r=s.querySelector("select");r&&this.setSelectLoading(r,!0)});try{if(!this.catalogCache.has(a)){const r=await z.get(`/api/public/catalog/${e}/${this.brand}`);if(r.success&&r.data){let l=r.data;t&&Array.isArray(l)&&(l=this.filterModelsBySubtype(l,e,t)),this.catalogCache.set(a,l)}else this.catalogCache.set(a,[])}const s=this.catalogCache.get(a)||[];n.forEach(r=>{const l=r.querySelector("select");l&&this.populateModelSelect(l,s,e)})}catch(s){console.error("Errore nel caricamento del catalogo:",s),n.forEach(r=>{const l=r.querySelector("select");l&&this.populateModelSelect(l,[],e)})}}}filterModelsBySubtype(e,t,a){if(t==="pompa-calore"){const o=["aria_aria","acqua_aria","salamoia_aria"];if(a==="riscaldamento")return e.filter(i=>{const n=i.tipologia_scambio||i.fields?.tipologia_scambio;return!o.includes(n)});if(a==="condizionatore")return e.filter(i=>{const n=i.tipologia_scambio||i.fields?.tipologia_scambio;return o.includes(n)})}else if(t==="solare-termico"){if(a==="factory")return e.filter(o=>(o.tipo_collettori||o.fields?.tipo_collettori)==="factory_made");if(a==="acs")return e.filter(o=>(o.utilizzo||o.fields?.utilizzo)==="solo_acs");if(a==="riscaldamento")return e.filter(o=>{const i=o.utilizzo||o.fields?.utilizzo;return i==="acs_riscaldamento"||i==="solo_riscaldamento"})}return e}setSelectLoading(e,t){e.disabled=t,t&&(e.innerHTML='<option value="">Caricamento modelli...</option>')}populateModelSelect(e,t,a){const o=e.id||e.name,i=`${a}-${o}`;this.choicesInstances.has(i)&&(this.choicesInstances.get(i).destroy(),this.choicesInstances.delete(i)),e.disabled=!1,e.innerHTML="";const n=document.createElement("option");n.value="",n.textContent=t.length>0?"Seleziona un modello...":"Nessun modello disponibile",e.appendChild(n),t.forEach((s,r)=>{const l=document.createElement("option");l.value=r,l.textContent=s.label||s.modello||`Modello ${r+1}`,l.dataset.modelIndex=r,s.fields&&(l.dataset.modelFields=JSON.stringify(s.fields)),e.appendChild(l)}),e.dataset.models=JSON.stringify(t),this.initializeChoices(e,i)}initializeChoices(e,t){if(typeof Choices>"u"){console.warn("Choices.js non è disponibile");return}const a=e.hasAttribute("readonly")||e.getAttribute("data-readonly")==="true",o=new Choices(e,{placeholder:!0,placeholderValue:"Seleziona un modello...",searchEnabled:!0,shouldSort:!1,position:"auto",noResultsText:"Nessun risultato",noChoicesText:"Nessun modello disponibile",itemSelectText:"Invio per confermare la scelta",loadingText:"Caricamento...",removeItemButton:!1,focusState:"is-focused"});a&&o.disable(),this.choicesInstances.set(t,o)}bindModelSelectEvents(){this.form.addEventListener("change",e=>{const t=e.target;t.tagName==="SELECT"&&(t.matches(".btn-select-model select")||t.closest(".btn-select-model")||t.hasAttribute("data-field"))&&this.handleModelSelect(t)})}handleModelSelect(e){const t=e.value;if(t==="")return;let a=[];try{a=JSON.parse(e.dataset.models||"[]")}catch(s){console.error("Errore nel parsing dei modelli:",s);return}const o=a[parseInt(t)];if(!o)return;const i=e.closest('[class*="-item"]')||e.closest(".tab-content");if(!i)return;const n=e.dataset.tipologia||this.currentTab?.catalogType;n&&this.applyModelToRow(o,i,n)}applyModelToRow(e,t,a){const o=e.fields||e,n={"pompa-calore":{modello:"modello",marca:"marca",tipologia_funzionamento:"tipologia_funzionamento",tipologia_scambio:"tipologia_scambio",nome_commerciale:"nome_commerciale",potenza_nominale:"potenza_nominale",efficienza_stagionale:"efficienza_stagionale",scop_sper_cop:"scop_sper_cop",emissione_nox:"emissione_nox",potenziale_gwp:"potenziale_gwp"},"sistema-ibrido":{pdc_modello:"modello",modello:"modello",marca:"marca",pdc_alimentazione:"pdc_alimentazione",pdc_tipologia_scambio:"pdc_tipologia_scambio",pdc_denominazione:"pdc_denominazione",pdc_potenza:"pdc_potenza",pdc_efficienza:"pdc_efficienza",pdc_scop_sper_cop:"pdc_scop_sper_cop",pdc_emissione:"pdc_emissione",pdc_potenziale:"pdc_potenziale",caldaia_tipologia:"caldaia_tipologia",caldaia_potenza:"caldaia_potenza",caldaia_rendimento:"caldaia_rendimento",caldaia_efficienza:"caldaia_efficienza"},"solare-termico":{modello:"modello",marca:"marca",tipo_collettori:"tipo_collettori",utilizzo:"utilizzo",area_ag:"area_ag",area_aa:"area_aa",energia_termica:"energia_termica"},scaldacqua:{modello:"modello",marca:"marca",classe_energetica:"classe_energetica",capacita_accumulo:"capacita_accumulo"}}[a]||{};Object.entries(n).forEach(([r,l])=>{const u=t.querySelector(`[data-field="${r}"]`);u&&o[l]!==void 0&&o[l]!==null&&(u.value=o[l])});const s=t.querySelector(".model-info");if(s){const r=s.querySelector(".model-details");r&&(r.textContent=this.formatModelDetails(o,a)),d(s)}e.id&&(t.dataset.templateId=e.id)}formatModelDetails(e,t){const a=[];return e.potenza_nominale&&a.push(`Potenza: ${e.potenza_nominale} kWt`),e.pdc_potenza&&a.push(`Potenza PdC: ${e.pdc_potenza} kWt`),e.efficienza_stagionale&&a.push(`Efficienza: ${e.efficienza_stagionale}%`),e.pdc_efficienza&&a.push(`Efficienza PdC: ${e.pdc_efficienza}%`),e.tipologia_scambio&&a.push(`Scambio: ${e.tipologia_scambio}`),e.classe_energetica&&a.push(`Classe: ${e.classe_energetica}`),e.capacita_accumulo&&a.push(`Capacità: ${e.capacita_accumulo}L`),e.tipo_collettori&&a.push(`Collettori: ${e.tipo_collettori}`),a.join(" | ")||"Nessun dettaglio disponibile"}bindCalculateButton(){const e=document.getElementById("calcola-incentivo");e&&e.addEventListener("click",async t=>{t.preventDefault(),await this.calculateIncentive()})}bindFormSubmit(){this.form&&this.form.addEventListener("submit",()=>{this.disableInactiveTabs()})}disableInactiveTabs(){this.allTabPanes.forEach(e=>{e.classList.contains(S.hidden)&&e.querySelectorAll("input, select, textarea").forEach(a=>{a.disabled=!0})})}async calculateIncentive(){const e=this.collectActiveTabData(),t=this.normalizeDataStructure(e);if(!t.intervention?.tipologia||t.intervention.tipologia.length===0){this.showError("Nessuna tipologia di intervento selezionata.");return}const a=["scaldacqua","solare-termico","pannelli-acs","pannelli-riscaldamento"],o=this.currentTab?.tabId;if(!a.includes(o)&&!t.property?.address?.immobile?.comune){this.showError("Inserisci il comune di installazione.");return}this.showLoading();try{const n=await z.post("/api/public/calculate",t);n.success?this.showResults(n.data):this.showError(n.error||"Errore nel calcolo. Verifica i dati inseriti.")}catch(n){console.error("Errore nel calcolo:",n),n.status===422&&n.data?.errors?this.showValidationErrors(n.data.errors):this.showError(n.message||"Errore di connessione. Riprova.")}}collectActiveTabData(){const e=new FormData(this.form),t={};for(const[a,o]of e.entries()){if(a.startsWith("dati_tecnici[")){const i=a.match(/dati_tecnici\[([^\]]+)\]/);if(i){const n=i[1],s=this.tipologiaAttivaInput?.value;if({sistema_ibrido:"sistema_ibrido",pompa_calore:"pompa_calore",scaldacqua:"scaldacqua",solare_termico:"solare_termico"}[n]!==s)continue}}this.setNestedValue(t,a,o)}return t}normalizeDataStructure(e){const t={...e};if(t.intervention?.tipologia&&(t.intervention.tipologia=[t.intervention.tipologia[""]]),t.dati_tecnici&&(t.value_vat=t.value_vat||{},Object.keys(t.dati_tecnici).forEach(a=>{const o=t.dati_tecnici[a];if(o&&typeof o=="object"&&!Array.isArray(o)){const i=[];Object.keys(o).forEach(n=>{if(/^\d+$/.test(n)){const s=o[n];s.value_vat&&(t.value_vat[a]=s.value_vat,delete s.value_vat),Object.hasOwn(s,"costo_unitario")&&(s.costo_unitario=t.value_vat[a]),i.push(s)}}),t.dati_tecnici[a]=i}})),t.addressed&&!Array.isArray(t.addressed)){const a=Object.values(t.addressed).filter(Boolean);t.addressed=a.length>0?a:["property"]}return t}setNestedValue(e,t,a){const o=t.replace(/\]/g,"").split("[");let i=e;for(let n=0;n<o.length;n++){const s=o[n];if(n===o.length-1)i[s]!==void 0?(Array.isArray(i[s])||(i[s]=[i[s]]),i[s].push(a)):i[s]=a;else{const r=o[n+1],l=/^\d+$/.test(r);i[s]===void 0&&(i[s]=l?[]:{}),i=i[s]}}}showLoading(){const{placeholder:e,loading:t,error:a,table:o}=this.resultsElements;c(e),c(a),c(o),d(t)}showError(e){const{placeholder:t,loading:a,table:o,error:i,errorMessage:n}=this.resultsElements;c(t),c(a),c(o),n&&(n.textContent=e),d(i)}showValidationErrors(e){const{placeholder:t,loading:a,table:o,error:i,errorMessage:n}=this.resultsElements;c(t),c(a),c(o);const s=Object.values(e).flat().join("<br>");n&&(n.innerHTML=s||"Errori di validazione. Verifica i dati inseriti."),d(i)}populateWarnings(e){const{warnings:t}=this.resultsElements;if(!t)return;const a=t.querySelector("#simulator-warnings-container")||t;let o=Object.values(e).filter(i=>i.hasOwnProperty("warnings")&&i.warnings).length;if(o===0){c(t),c(a);return}for(const[i,n]of Object.entries(e)){const s=Array.isArray(n)?n:[n];if(s.length===0)continue;const r=s[0];if(r.warnings){o--;const l=a.querySelector(`#simulator-warnings-${i}`),u=a.querySelector(`#separator-warnings-${i}`);if(l){const m=l.querySelector("p.warnings-message");if(m){const h=typeof r.warnings=="object"?r.warnings[i]||Object.values(r.warnings).join("<br>"):r.warnings;m.innerHTML=h}d(l)}u&&o>0&&d(u)}}d(a),d(t)}resetWarnings(){const{warnings:e}=this.resultsElements;if(!e)return;const t=e.querySelector("#simulator-warnings-container")||e,a=t.querySelectorAll('[id^="simulator-warnings-"]:not(#simulator-warnings-container)'),o=t.querySelectorAll('[id^="separator-warnings-"]');a.forEach(i=>c(i)),o.forEach(i=>c(i)),c(t),c(e)}showResults(e){const{placeholder:t,loading:a,error:o,table:i,body:n,totalImporto:s,totalLordo:r,totalNetto:l}=this.resultsElements;if(c(t),c(a),c(o),!i||!n)return;n.innerHTML="",this.resetWarnings();let u=0,m=0,h=0;Object.entries(e).forEach(([b,f])=>{const v=C[b]||b,_=this.safeToFloat(f.totale_vat||0),y=this.safeToFloat(f.incentivo_lordo||0),E=this.safeToFloat(f.incentivo_netto||0),w=f.percent_reale||0;u+=_,m+=y,h+=E;const g=document.createElement("tr");g.className="border-b border-gray-200 hover:bg-gray-50",g.innerHTML=`
                <td class="px-4 py-3 font-medium">${v}</td>
                <td class="px-4 py-3 text-right">&euro; ${p(_)}</td>
                <td class="px-4 py-3 text-right">&euro; ${p(y)}</td>
                <td class="px-4 py-3 text-right font-semibold text-green-600">&euro; ${p(E)}</td>
                <td class="px-4 py-3 text-right">${parseFloat(w).toFixed(1)}%</td>
            `,n.appendChild(g)}),s&&(s.innerHTML=`&euro; ${p(u)}`),r&&(r.innerHTML=`&euro; ${p(m)}`),l&&(l.innerHTML=`&euro; ${p(h)}`),this.populateWarnings(e),d(i)}safeToFloat(e){if(typeof e=="number")return e;if(typeof e=="string")try{return I(e)}catch{return parseFloat(e)||0}return 0}}document.addEventListener("DOMContentLoaded",()=>{new B});
